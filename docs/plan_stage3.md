# Stage 3 Plan – Monte Carlo Updates

## Goals
- 实现动量世界线 `K_σ` 的局部 Metropolis 更新，遵守 `note.md` 中的接受率公式。
- 实现 permutation 换位更新，正确维护符号与相位增量。
- 维护增量 `S(X)` 与接受率统计，为 Stage 4 测量做准备。

## 更新类型
1. **动量更新**
   - 随机选择 `(σ, l, n)`，提议 `k_{l,σ}^{(n)} → k'`。
   - 若新动量在该切片已被其它粒子占据则立即拒绝。
   - 接受率使用 `note.md` 中关于 `R_k` 的公式，注意处理 `l=0` 与 `l=L_τ-1` 的边界项。
   - 相位增量采用对应的 `ΔΦ_k` 表达式。

2. **Permutation 换位**
   - 在自旋 σ 末片选择两个不同粒子 `(a, b)`，尝试换位。
   - 接受率依照 `note.md` 的 `R_p` 公式计算。
   - 成功时乘以 `-1` 并加入 `ΔΦ_perm`。

## 状态与缓存
- 定义 `MonteCarloState`：包含 `WorldlineConfiguration`、当前复相位 `S`、当前对数权重、以及必要的缓存（如临近转移矩阵元）。
- 记录每类更新的尝试次数与接受次数，便于输出接受率。
- 使用 `rng.make_generator` 控制随机数。

## 测试计划
- 小体系（如 `L=2, Lτ=2`）固定 seed，运行少量 sweep：
  - 检查 Pauli 约束不会被破坏。
  - 在 `U=0` 情况验证接受率与解析结果一致。
  - 验证相位累计值与显式计算的 `S(X)` 相同。
- 编写单元测试覆盖动量更新、换位更新的比值计算和接受率统计。

## 文档
- 完成后在 `AGENTS.md` 添加 Stage 3 记录。
- 在关键代码处引用 `note.md` 中使用的公式编号或表达式。
